async function loadHtml2Canvas() {
  if (window.html2canvas) {
    return window.html2canvas;
  }

  return new Promise((resolve, reject) => {
    const script = document.createElement("script");
    script.src = "https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js";
    script.onload = () => resolve(window.html2canvas);
    script.onerror = reject;
    document.head.appendChild(script);
  });
}

async function generateShareImage(
  { map, showLoading, hideLoading, showError },
) {
  try {
    showLoading("Generating image...");
    await loadHtml2Canvas();

    const container = document.createElement("div");
    container.style.position = "absolute";
    container.style.left = "-9999px";
    container.style.width = "1200px";
    container.style.height = "630px";
    document.body.appendChild(container);

    const screenshotMap = L.map(container, {
      zoomControl: false,
      attributionControl: false,
    });

    screenshotMap.setView(map.getCenter(), map.getZoom());

    const screenshotBaseLayer = protomapsL.leafletLayer({
      url:
        "https://api.protomaps.com/tiles/v3/{z}/{x}/{y}.mvt?key=ee3e89f1234d79e1",
      theme: window.currentTheme === "dark" ? "black" : "white",
    });
    await new Promise((resolve) => {
      screenshotBaseLayer.addTo(screenshotMap);
      screenshotBaseLayer.on("load", resolve);
    });

    window.markers.forEach((marker) => {
      L.marker(marker.getLatLng()).addTo(screenshotMap);
    });

    window.polygonLayers.forEach((layer, timezone) => {
      const color = window.timezoneColors.get(timezone);
      L.geoJSON(layer.toGeoJSON(), {
        style: {
          color,
          weight: 2.5,
          opacity: 0.9,
          fillColor: color,
          fillOpacity: 0.15,
        },
      }).addTo(screenshotMap);
    });

    const watermark = document.createElement("div");
    watermark.className = "watermark";
    watermark.textContent = "Generated by tzf-web";
    container.appendChild(watermark);

    await new Promise((resolve) => setTimeout(resolve, 1000));

    const canvas = await html2canvas(container, {
      useCORS: true,
      allowTaint: true,
      backgroundColor: window.currentTheme === "dark" ? "#1a202c" : "#ffffff",
    });

    const link = document.createElement("a");
    link.download = "tzf-map-" +
      new Date().toISOString().slice(0, 19).replace(/[:-]/g, "") +
      ".png";
    link.href = canvas.toDataURL("image/png");
    link.click();

    document.body.removeChild(container);
    hideLoading();
  } catch (error) {
    console.error("Error generating image:", error);
    hideLoading();
    showError("Failed to generate image. Please try again.");
  }
}

export function initShareImage({ map, showLoading, hideLoading, showError }) {
  const shareImageButton = document.getElementById("share-image-button");
  if (!shareImageButton) {
    return;
  }

  shareImageButton.addEventListener(
    "click",
    () => generateShareImage({ map, showLoading, hideLoading, showError }),
  );
}
