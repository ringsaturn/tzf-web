<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>tzf-web</title>
    <meta name="author" content="ringsaturn" />
    <meta name="keywords" content="tzf, timezone, wasm, leaflet, protomaps" />
    <meta
      name="description"
      content="A simple web app to find the timezone of a location using WebAssembly."
    />

    <meta name="twitter:card" content="summary" />
    <meta name="twitter:creator" content="@ringsaturn_me" />

    <meta name="og:image" content="./android-chrome-512x512.png" />
    <meta property="og:url" content="https://ringsaturn.github.io/tzf-web/" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="tzf-web" />
    <meta
      property="og:description"
      content="A simple web app to find the timezone of a location using WebAssembly."
    />
    <meta property="og:site_name" content="tzf-web" />

    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="./apple-touch-icon.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="./favicon-32x32.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="./favicon-16x16.png"
    />
    <link rel="manifest" href="./site.webmanifest" />

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script
      src="https://unpkg.com/protomaps-leaflet/dist/protomaps-leaflet.js"
    ></script>

    <script type="module">
      import init, {
        WasmFinder,
      } from "https://unpkg.com/tzf-wasm@0.1.6/tzf_wasm.js";

      // 定义一组视觉上区分度高的颜色
      const colorPalette = [
        "#2c5282", // 深蓝色
        "#c53030", // 深红色
        "#2f855a", // 深绿色
        "#744210", // 深棕色
        "#553c9a", // 深紫色
        "#702459", // 深粉色
        "#1a365d", // 海军蓝
        "#975a16", // 赭石色
        "#285e61", // 深青色
        "#822727", // 暗红色
        "#45359a", // 靛蓝色
        "#5b3f11", // 深褐色
        "#234e52", // 深绿青
        "#48366d", // 深靛蓝
        "#3c366b", // 深紫蓝
      ];

      window.finder = null;
      window.loadedTimezones = new Set();
      window.timezoneColors = new Map();
      window.indexLayers = new Map();
      window.markers = new Map(); // Store multiple markers
      let colorIndex = 0;

      window.showIndexData =
        localStorage.getItem("showIndexData") === "true";

      // 获取时区的颜色，确保相邻时区颜色不同
      function getTimezoneColor(timezone) {
        if (!window.timezoneColors.has(timezone)) {
          window.timezoneColors.set(
            timezone,
            colorPalette[colorIndex % colorPalette.length],
          );
          colorIndex++;
        }
        return window.timezoneColors.get(timezone);
      }

      function getUrlParams() {
        const params = new URLSearchParams(window.location.search);
        return {
          lat: parseFloat(params.get("lat")),
          lng: parseFloat(params.get("lng")),
          zoom: parseInt(params.get("zoom")),
          showIndex: params.get("showIndex") === "true",
          bounds: params.get("bounds")
            ? JSON.parse(decodeURIComponent(params.get("bounds")))
            : null,
          timezones: params.get("timezones")
            ? params.get("timezones").split(",")
            : [],
          markers: params.getAll("marker").map((m) => {
            const [lat, lng] = m.split(",").map(parseFloat);
            return { lat, lng };
          }),
        };
      }

      function getShareableUrl() {
        const bounds = map.getBounds();
        const center = map.getCenter();
        const zoom = map.getZoom();
        const params = new URLSearchParams();

        // Add map state
        params.set("lat", center.lat.toFixed(4));
        params.set("lng", center.lng.toFixed(4));
        params.set("zoom", zoom);
        params.set(
          "bounds",
          encodeURIComponent(JSON.stringify({
            north: bounds.getNorth().toFixed(4),
            south: bounds.getSouth().toFixed(4),
            east: bounds.getEast().toFixed(4),
            west: bounds.getWest().toFixed(4),
          })),
        );

        // Add all markers
        for (const [key, marker] of window.markers.entries()) {
          const pos = marker.getLatLng();
          params.append(
            "marker",
            `${pos.lat.toFixed(4)},${pos.lng.toFixed(4)}`,
          );
        }

        // Add visible timezones
        if (window.loadedTimezones.size > 0) {
          params.set(
            "timezones",
            Array.from(window.loadedTimezones).join(","),
          );
        }

        // Add index data state
        params.set("showIndex", window.showIndexData);

        return `${window.location.origin}${window.location.pathname}?${params.toString()}`;
      }

      window.showTimezone = async function (
        lat,
        lng,
        map,
        markerId = null,
      ) {
        if (!window.finder) {
          alert(
            "WASM module is not loaded yet. Please wait for a few seconds.",
          );
          return;
        }

        if (isNaN(lng) || isNaN(lat)) {
          alert(
            "Please enter valid numbers for longitude and latitude.",
          );
          return;
        }

        if (lng < -180 || lng > 180) {
          alert(
            "Please enter a valid longitude between -180 and 180 degrees.",
          );
          return;
        }

        if (lat < -90 || lat > 90) {
          alert(
            "Please enter a valid latitude between -90 and 90 degrees.",
          );
          return;
        }

        const roundedLat = lat.toFixed(4);
        const roundedLng = lng.toFixed(4);
        const timezones = window.finder.get_tz_names(
          roundedLng,
          roundedLat,
        );
        var joinedTimezones = timezones.join(", ");

        // Generate a unique ID for the marker if not provided
        const id = markerId || `marker-${Date.now()}`;

        // Create and store the marker
        const marker = L.marker([roundedLat, roundedLng]).addTo(map);
        window.markers.set(id, marker);

        marker.bindPopup(
          `Latitude: ${roundedLat}<br>Longitude: ${roundedLng}<br>Timezone: ${joinedTimezones}`,
        ).openPopup();

        for (const timezone of timezones) {
          const geojsonPath = `./timezone-polygons/${
            timezone.replace(/\//g, "-")
          }.geojson`;
          const indexGeojsonPath = `./timezone-polygons-index/${
            timezone.replace(/\//g, "-")
          }.geojson`;

          if (!window.loadedTimezones.has(timezone)) {
            window.loadedTimezones.add(timezone);

            try {
              // Load detailed boundary
              const response = await fetch(geojsonPath);
              if (response.ok) {
                const geojsonData = await response.json();
                const timezoneColor = getTimezoneColor(timezone);
                const timezoneLayer = L.geoJSON(geojsonData, {
                  style: {
                    color: timezoneColor,
                    weight: 2.5,
                    opacity: 0.9,
                    fillColor: timezoneColor,
                    fillOpacity: 0.15,
                  },
                  onEachFeature: function (feature, layer) {
                    layer.bindTooltip(timezone.split("/").pop(), {
                      permanent: true,
                      direction: "center",
                      className: "timezone-label",
                    });
                  },
                }).addTo(map);
              }

              // Load index boundary
              const indexResponse = await fetch(indexGeojsonPath);
              if (indexResponse.ok) {
                const indexGeojsonData = await indexResponse.json();
                const timezoneColor = getTimezoneColor(timezone);
                const indexTimezoneLayer = L.geoJSON(indexGeojsonData, {
                  style: {
                    color: timezoneColor,
                    weight: 1.5,
                    opacity: 0.7,
                    fillColor: timezoneColor,
                    fillOpacity: 0.1,
                  },
                });

                window.indexLayers.set(timezone, indexTimezoneLayer);
                if (window.showIndexData) {
                  indexTimezoneLayer.addTo(map);
                }
              }
            } catch (error) {
              console.error(
                `Error loading GeoJSON for ${timezone}:`,
                error,
              );
            }
          }
        }
      };

      window.toggleIndexData = function () {
        window.showIndexData = !window.showIndexData;
        localStorage.setItem("showIndexData", window.showIndexData);
        document.getElementById("show-index-data").checked =
          window.showIndexData;

        for (const [timezone, layer] of window.indexLayers.entries()) {
          if (window.showIndexData) {
            layer.addTo(map);
          } else {
            layer.remove();
          }
        }
      };

      async function loadWasm() {
        await init();
        window.finder = new WasmFinder();

        // Process URL parameters after WASM is loaded
        const urlParams = getUrlParams();

        if (urlParams.showIndex !== null) {
          window.showIndexData = urlParams.showIndex;
          document.getElementById("show-index-data").checked =
            urlParams.showIndex;
        }

        // Load markers from URL if present
        if (urlParams.markers && urlParams.markers.length > 0) {
          for (const marker of urlParams.markers) {
            await showTimezone(marker.lat, marker.lng, map);
          }
        }
      }

      // Get URL parameters for initial map view
      const urlParams = getUrlParams();

      // Initialize map
      var southWest = L.latLng(-90, -180);
      var northEast = L.latLng(90, 180);
      var bounds = L.latLngBounds(southWest, northEast);

      var map = L.map("map", {
        maxBounds: bounds,
        maxBoundsViscosity: 1,
        worldCopyJump: true,
        maxZoom: 18,
        minZoom: 3,
        cursor: true,
      }).setView(
        urlParams.lat && urlParams.lng
          ? [urlParams.lat, urlParams.lng]
          : [40.7128, -74.0060],
        urlParams.zoom || 2,
      );

      // Add base layer
      var layer = protomapsL.leafletLayer({
        url:
          "https://api.protomaps.com/tiles/v3/{z}/{x}/{y}.mvt?key=ee3e89f1234d79e1",
        theme: "white",
      });
      layer.addTo(map);

      // Add attribution
      map.attributionControl.addAttribution(
        '&copy; <a href="https://github.com/evansiroky/timezone-boundary-builder" target="_blank">timezone-boundary-builder</a>',
      );

      // Add grid layer
      L.GridLayer.GridDebug = L.GridLayer.extend({
        createTile: function (coords) {
          const tile = document.createElement("div");
          tile.style.outline = "1px solid rgba(208, 240, 192, 1)";
          tile.style.fontSize = "13pt";
          tile.style.opacity = "1";
          tile.innerHTML = [coords.z, coords.x, coords.y].join("/");
          return tile;
        },
      });
      L.gridLayer.gridDebug = function (opts) {
        return new L.GridLayer.GridDebug(opts);
      };
      map.addLayer(L.gridLayer.gridDebug());

      // Add event listeners
      document.getElementById("add-marker").addEventListener(
        "click",
        () => {
          const lat = parseFloat(
            document.getElementById("latitude").value,
          );
          const lon = parseFloat(
            document.getElementById("longitude").value,
          );
          if (!isNaN(lat) && !isNaN(lon)) {
            showTimezone(lat, lon, map);
          } else {
            alert("Please enter valid latitude and longitude values.");
          }
        },
      );

      map.on("mousemove", function (e) {
        var lng = e.latlng.wrap().lng.toFixed(4);
        var lat = e.latlng.wrap().lat.toFixed(4);
        if (window.finder) {
          var timezones = window.finder.get_tz_names(lng, lat);
          var joinedTimezones = timezones.join(", ");
          var dataVersion = window.finder.data_version();
          document.getElementById("mousecoord").innerHTML =
            `Data Version: ${dataVersion}<br>Lat: ${lat} Lng: ${lng}<br>Timezone: ${joinedTimezones}`;
        } else {
          document.getElementById("mousecoord").innerHTML =
            `Lat: ${lat} Lng: ${lng}`;
        }
      });

      map.on("click", function (e) {
        const lat = e.latlng.lat;
        const lng = e.latlng.lng;
        showTimezone(lat, lng, map);
      });

      document.getElementById("share-button").addEventListener(
        "click",
        async () => {
          const url = getShareableUrl();
          try {
            await navigator.clipboard.writeText(url);
            alert("URL copied to clipboard!");
          } catch (err) {
            console.error("Failed to copy URL:", err);
            alert("Failed to copy URL. Please try again.");
          }
        },
      );

      // Initialize checkbox state
      document.getElementById("show-index-data").checked =
        window.showIndexData;

      // Load WASM
      loadWasm();
    </script>

    <style>
      html,
      body,
      #map {
        height: 100%;
        margin: 0;
        padding: 0;
        font-family:
          -apple-system,
          BlinkMacSystemFont,
          "Segoe UI",
          Roboto,
          "Helvetica Neue",
          Arial,
          sans-serif;
      }

      .panel {
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        z-index: 1000;
      }

      #coordinate-inputs {
        position: absolute;
        top: 20px;
        left: 20px;
      }

      #mousecoord {
        position: absolute;
        right: 20px;
        top: 20px;
        padding: 10px 15px;
        font-size: 14px;
        line-height: 1.5;
      }

      footer {
        position: absolute;
        bottom: 20px;
        left: 20px;
        max-width: 400px;
      }

      footer ul {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      footer li {
        margin-bottom: 8px;
      }

      footer a {
        color: #2b6cb0;
        text-decoration: none;
        transition: color 0.2s;
        font-weight: 500;
      }

      footer a:hover {
        color: #1a4971;
        text-decoration: underline;
      }

      .input-group {
        margin-bottom: 12px;
      }

      .input-group label {
        display: inline-block;
        width: 40px;
        color: #4a5568;
        font-size: 14px;
      }

      .input-group input {
        width: 120px;
        padding: 6px 10px;
        border: 1px solid #e2e8f0;
        border-radius: 4px;
        font-size: 14px;
        transition: border-color 0.2s;
      }

      .input-group input:focus {
        outline: none;
        border-color: #4299e1;
        box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
      }

      button {
        background-color: #4299e1;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 8px 16px;
        font-size: 14px;
        cursor: pointer;
        transition: background-color 0.2s;
      }

      button:hover {
        background-color: #3182ce;
      }

      #add-marker {
        width: 100%;
        margin-bottom: 12px;
      }

      .controls-container {
        display: flex;
        align-items: center;
        margin-bottom: 12px;
      }

      .toggle-switch {
        margin-right: 10px;
        width: 16px;
        height: 16px;
      }

      .toggle-label {
        font-size: 14px;
        color: #4a5568;
      }

      .share-button {
        width: 100%;
        background-color: #48bb78;
      }

      .share-button:hover {
        background-color: #38a169;
      }

      .timezone-label {
        background: none;
        border: none;
        box-shadow: none;
        color: #1a202c;
        font-weight: 600;
        font-size: 12px;
        text-shadow:
          2px 2px 3px rgba(255, 255, 255, 0.9),
          -2px -2px 3px rgba(255, 255, 255, 0.9),
          2px -2px 3px rgba(255, 255, 255, 0.9),
          -2px 2px 3px rgba(255, 255, 255, 0.9);
      }
    </style>
  </head>

  <body>
    <div id="map"></div>
    <div id="coordinate-inputs" class="panel">
      <div class="input-group">
        <label for="latitude">Lat:</label>
        <input
          type="text"
          id="latitude"
          name="latitude"
          placeholder="e.g. 40.7128"
        />
      </div>
      <div class="input-group">
        <label for="longitude">Lng:</label>
        <input
          type="text"
          id="longitude"
          name="longitude"
          placeholder="e.g. -74.0060"
        />
      </div>
      <button id="add-marker">Add Marker</button>
      <div class="controls-container">
        <input
          type="checkbox"
          id="show-index-data"
          class="toggle-switch"
          onchange="toggleIndexData()"
        />
        <label for="show-index-data" class="toggle-label"
        >Show Index Data</label>
      </div>
      <button id="share-button" class="share-button">Share Current View</button>
    </div>
    <div id="mousecoord" class="panel"></div>
    <footer class="panel">
      <ul>
        <li>
          <a href="https://ringsaturn.github.io/tzf-web/simple" target="_blank"
          >Simple Page</a>
        </li>
        <li>
          <a href="https://github.com/ringsaturn/tzf-web" target="_blank"
          >Project Repository</a>
        </li>
        <li>
          This project uses <a
            href="https://github.com/ringsaturn/tzf-wasm"
            target="_blank"
          >tzf-wasm</a>, which is a Wasm binding of <a
            href="https://github.com/ringsaturn/tzf-rs"
            target="_blank"
          >tzf-rs</a>.
        </li>
      </ul>
    </footer>
  </body>
</html>
